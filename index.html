<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Gantt Chart Builder Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar h1 {
            font-size: 20px;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar .credit {
            font-size: 10px;
            opacity: 0.6;
            font-weight: normal;
            font-style: italic;
        }

        .toolbar button, .toolbar input {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .toolbar button {
            background: #3498db;
            color: white;
            transition: background 0.3s;
        }

        .toolbar button:hover {
            background: #2980b9;
        }

        .toolbar input[type="date"], .toolbar input[type="number"] {
            padding: 7px 10px;
        }

        .toolbar label {
            font-size: 14px;
        }

        .stats-bar {
            background: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            opacity: 0.8;
        }

        .stat-value {
            font-weight: bold;
            font-size: 14px;
        }

        .filter-bar {
            background: #ecf0f1;
            padding: 12px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 2px solid #bdc3c7;
        }

        .filter-bar input, .filter-bar select {
            padding: 6px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
        }

        .filter-bar label {
            font-size: 13px;
            font-weight: 500;
        }

        .gantt-wrapper {
            display: flex;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 60vh;
        }

        .task-list {
            min-width: 350px;
            background: #ecf0f1;
            border-right: 2px solid #bdc3c7;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .task-list-header {
            background: #34495e;
            color: white;
            padding: 12px;
            font-weight: bold;
            border-bottom: 2px solid #2c3e50;
            height: 80px;
            display: flex;
            align-items: center;
        }

        .task-row {
            padding: 8px 12px;
            border-bottom: 1px solid #bdc3c7;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 50px;
            background: white;
            position: relative;
        }

        .task-row:hover {
            background: #f8f9fa;
        }

        .task-row:hover .move-buttons {
            display: flex;
        }

        .task-indent {
            width: 20px;
        }

        .task-toggle {
            cursor: pointer;
            user-select: none;
            width: 16px;
            text-align: center;
        }

        .task-name {
            flex: 1;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .task-main-name {
            font-weight: 500;
        }

        .task-meta {
            font-size: 11px;
            color: #7f8c8d;
            display: flex;
            gap: 10px;
        }

        .task-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .task-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        .priority-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .priority-low { background: #95a5a6; }
        .priority-medium { background: #f39c12; }
        .priority-high { background: #e74c3c; }

        .move-buttons {
            display: none;
            gap: 2px;
            margin-left: auto;
        }

        .move-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .move-btn:hover {
            background: #2980b9;
        }

        .timeline {
            flex: 1;
            overflow-x: auto;
            min-width: 0;
        }

        .timeline-header {
            display: flex;
            background: #34495e;
            color: white;
            border-bottom: 2px solid #2c3e50;
            height: 80px;
            flex-direction: column;
            position: sticky;
            top: 0;
            z-index: 5;
            min-width: min-content;
        }

        .week-header, .day-header {
            min-width: min-content;
        }

        .week-header {
            display: flex;
            height: 40px;
        }

        .week-cell {
            min-width: 140px;
            padding: 8px;
            border-right: 1px solid #2c3e50;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-header {
            display: flex;
            height: 40px;
        }

        .day-cell {
            min-width: 20px;
            padding: 4px;
            border-right: 1px solid #4a5f7f;
            text-align: center;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-grid {
            position: relative;
            min-width: min-content;
        }

        .grid-row {
            display: flex;
            min-height: 50px;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
            min-width: min-content;
        }

        .grid-cell {
            min-width: 20px;
            border-right: 1px solid #ecf0f1;
        }

        .grid-cell.weekend {
            background: #f8f9fa;
        }

        .task-bar {
            position: absolute;
            height: 28px;
            top: 11px;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            color: white;
            font-weight: 500;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .task-bar.parent {
            background: #2c3e50;
            height: 8px;
            top: 21px;
            border-radius: 2px;
        }

        .task-bar.child {
            background: #3498db;
        }

        .task-bar.critical {
            background: #e74c3c;
            border: 2px solid #c0392b;
        }

        .task-bar.high-priority {
            border: 2px solid #e74c3c;
        }

        .task-bar.milestone {
            width: 20px !important;
            height: 20px;
            background: #e74c3c;
            transform: rotate(45deg);
            top: 15px;
            padding: 0;
            cursor: pointer;
        }

        .task-bar.deadline {
            width: 3px !important;
            height: 100%;
            background: #e74c3c;
            top: 0;
            padding: 0;
            border-radius: 0;
        }

        .today-line {
            width: 2px !important;
            height: 100%;
            background: #27ae60;
            top: 0;
            padding: 0;
            border-radius: 0;
            box-shadow: 0 0 5px rgba(39, 174, 96, 0.5);
        }

        .progress-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px 0 0 4px;
            pointer-events: none;
        }

        .resize-handle {
            position: absolute;
            width: 8px;
            height: 100%;
            top: 0;
            cursor: ew-resize;
            background: rgba(255,255,255,0.3);
        }

        .resize-handle.left {
            left: 0;
        }

        .resize-handle.right {
            right: 0;
        }

        .dependency-line {
            position: absolute;
            stroke: #95a5a6;
            stroke-width: 2;
            fill: none;
            pointer-events: none;
        }

        .dependency-line.critical {
            stroke: #e74c3c;
            stroke-width: 3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
        }

        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-buttons .save {
            background: #27ae60;
            color: white;
        }

        .modal-buttons .cancel {
            background: #95a5a6;
            color: white;
        }

        .help-content {
            line-height: 1.6;
        }

        .help-content h3 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .help-content ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .help-content li {
            margin-bottom: 5px;
        }

        select[multiple] {
            min-height: 100px;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #bdc3c7;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <h1>üìä Gantt Chart Builder Pro <span class="credit">Parmiters School Computing Dept</span></h1>
            <label>Start Date:</label>
            <input type="date" id="startDate">
            <label>Weeks:</label>
            <input type="number" id="numWeeks" value="8" min="1" max="52" style="width: 60px;">
            <button onclick="updateTimeline()">Update Timeline</button>
            <button onclick="addTask()">+ Add Task</button>
            <button onclick="addMilestone()">+ Add Milestone</button>
            <button onclick="setDeadline()">Set Deadline</button>
            <button onclick="toggleCriticalPath()" id="criticalPathBtn">Show Critical Path</button>
            <button onclick="manageAssignees()">üë• Manage Assignees</button>
            <button onclick="saveProject()">üíæ Save JSON</button>
            <button onclick="loadProject()">üìÇ Load JSON</button>
            <button onclick="exportToPNG()">üì∑ Export PNG</button>
            <button onclick="showHelp()">‚ùì Help</button>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">Total Tasks:</span>
                <span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Completed:</span>
                <span class="stat-value" id="statCompleted">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">In Progress:</span>
                <span class="stat-value" id="statInProgress">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Avg Progress:</span>
                <span class="stat-value" id="statAvgProgress">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Duration:</span>
                <span class="stat-value" id="statDuration">0 days</span>
            </div>
        </div>

        <div class="filter-bar">
            <label>üîç Search:</label>
            <input type="text" id="searchFilter" placeholder="Search tasks..." oninput="applyFilters()">
            <label>üë§ Assignee:</label>
            <select id="assigneeFilter" onchange="applyFilters()">
                <option value="">All</option>
            </select>
            <label>‚ö° Priority:</label>
            <select id="priorityFilter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
        </div>

        <div class="gantt-wrapper">
            <div class="task-list">
                <div class="task-list-header">Task Details</div>
                <div id="taskListBody"></div>
            </div>
            <div class="timeline">
                <div class="timeline-header" id="timelineHeader"></div>
                <div class="timeline-grid" id="timelineGrid"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Task</h2>
            <label>Task Name:</label>
            <input type="text" id="modalTaskName">
            <label>Type:</label>
            <select id="modalTaskType">
                <option value="child">Child Task</option>
                <option value="parent">Parent Task</option>
                <option value="milestone">Milestone</option>
            </select>
            <label>Start Date:</label>
            <input type="date" id="modalStartDate">
            <label>Duration (days):</label>
            <input type="number" id="modalDuration" value="3" min="1">
            <label>Progress (%):</label>
            <input type="number" id="modalProgress" value="0" min="0" max="100">
            <label>Assignee:</label>
            <select id="modalAssignee">
                <option value="">None</option>
            </select>
            <input type="text" id="modalAssigneeCustom" placeholder="Or type new assignee name" style="margin-top: 5px;">
            <label>Priority:</label>
            <select id="modalPriority">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
            <label>Custom Color:</label>
            <input type="color" id="modalColor" value="#3498db">
            <span class="color-preview" id="colorPreview"></span>
            <label>Parent Task (optional):</label>
            <select id="modalParent">
                <option value="">None</option>
            </select>
            <label>Dependencies (tasks that must finish before this one):</label>
            <select id="modalDependencies" multiple>
            </select>
            <small style="color: #7f8c8d; font-size: 11px;">Hold Ctrl/Cmd to select multiple</small>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeModal()">Cancel</button>
                <button class="save" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="helpModal">
        <div class="modal-content">
            <h2>Gantt Chart Pro - User Guide</h2>
            <div class="help-content">
                <h3>Key Features</h3>
                <ul>
                    <li><strong>Task Management:</strong> Create parent tasks, child tasks, and milestones</li>
                    <li><strong>Dependencies:</strong> Link tasks that depend on each other</li>
                    <li><strong>Critical Path:</strong> Automatically identifies the longest sequence of dependent tasks</li>
                    <li><strong>Progress Tracking:</strong> Set completion percentage for each task</li>
                    <li><strong>Filtering:</strong> Search and filter by assignee and priority</li>
                </ul>

                <h3>How to Use</h3>
                <ul>
                    <li><strong>Add Tasks:</strong> Click "+ Add Task" button</li>
                    <li><strong>Edit Tasks:</strong> Double-click task name in the list</li>
                    <li><strong>Move Tasks:</strong> Drag task bars left/right to change dates</li>
                    <li><strong>Resize Tasks:</strong> Drag the edges of task bars to change duration</li>
                    <li><strong>Collapse/Expand:</strong> Click ‚ñº/‚ñ∂ next to parent tasks</li>
                    <li><strong>Reorder:</strong> Use ‚Üë/‚Üì buttons when hovering over tasks</li>
                </ul>

                <h3>Dependencies & Critical Path</h3>
                <ul>
                    <li>Select dependencies when creating/editing tasks</li>
                    <li>Grey lines show task dependencies</li>
                    <li>Click "Show Critical Path" to highlight the longest task chain</li>
                    <li>Critical path tasks appear in red</li>
                </ul>

                <h3>Visual Indicators</h3>
                <ul>
                    <li><strong>Colored dots:</strong> Task priority (grey=low, orange=medium, red=high)</li>
                    <li><strong>Progress bars:</strong> White overlay shows task completion</li>
                    <li><strong>Green line:</strong> Today's date</li>
                    <li><strong>Red line:</strong> Project deadline</li>
                </ul>

                <h3>Save & Export</h3>
                <ul>
                    <li><strong>Save JSON:</strong> Download project as JSON file</li>
                    <li><strong>Load JSON:</strong> Import previously saved project</li>
                    <li><strong>Export PNG:</strong> Download chart as PNG image</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeHelp()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="assigneeModal">
        <div class="modal-content">
            <h2>Manage Team Assignees</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Add New Assignee:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newAssigneeName" placeholder="Enter name" style="flex: 1;">
                    <button onclick="addAssignee()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Add</button>
                </div>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Current Assignees:</label>
                <div id="assigneeList" style="max-height: 300px; overflow-y: auto; border: 1px solid #bdc3c7; border-radius: 4px; padding: 10px;">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeAssigneeModal()">Close</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" accept=".json">

    <script>
        let startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        let numWeeks = 8;
        let tasks = [];
        let deadline = null;
        let draggedTask = null;
        let resizeTask = null;
        let resizeDirection = null;
        let dragStartX = 0;
        let editingTaskId = null;
        let showCritical = false;
        let criticalPath = [];
        let filteredTasks = [];
        let assigneeList = [];

        const dayWidth = 20;

        function initializeDate() {
            const dateInput = document.getElementById('startDate');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dateInput.value = today.toISOString().split('T')[0];
            startDate = new Date(today);
        }

        function updateTimeline() {
            const dateInput = document.getElementById('startDate').value;
            if (dateInput) {
                startDate = new Date(dateInput);
                startDate.setHours(0, 0, 0, 0);
            }
            numWeeks = parseInt(document.getElementById('numWeeks').value) || 8;
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const assigneeFilter = document.getElementById('assigneeFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;

            filteredTasks = tasks.filter(task => {
                const matchesSearch = task.name.toLowerCase().includes(searchTerm) || 
                                    (task.assignee && task.assignee.toLowerCase().includes(searchTerm));
                const matchesAssignee = !assigneeFilter || task.assignee === assigneeFilter;
                const matchesPriority = !priorityFilter || task.priority === priorityFilter;
                
                return matchesSearch && matchesAssignee && matchesPriority;
            });

            updateAssigneeFilter();
            calculateCriticalPath();
            updateStats();
            render();
        }

        function updateAssigneeFilter() {
            const select = document.getElementById('assigneeFilter');
            const currentValue = select.value;
            const assignees = [...new Set([...assigneeList, ...tasks.map(t => t.assignee).filter(Boolean)])];
            
            select.innerHTML = '<option value="">All</option>';
            assignees.forEach(assignee => {
                select.innerHTML += `<option value="${assignee}">${assignee}</option>`;
            });
            select.value = currentValue;
        }

        function manageAssignees() {
            renderAssigneeList();
            document.getElementById('assigneeModal').classList.add('active');
        }

        function renderAssigneeList() {
            const listDiv = document.getElementById('assigneeList');
            if (assigneeList.length === 0) {
                listDiv.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No assignees added yet</p>';
            } else {
                listDiv.innerHTML = assigneeList.map(assignee => `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #ecf0f1; gap: 10px;">
                        <span style="flex: 1; font-size: 14px;">${assignee}</span>
                        <button onclick="removeAssignee('${assignee}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">Remove</button>
                    </div>
                `).join('');
            }
        }

        function addAssignee() {
            const name = document.getElementById('newAssigneeName').value.trim();
            if (!name) {
                alert('Please enter an assignee name');
                return;
            }
            if (assigneeList.includes(name)) {
                alert('This assignee already exists');
                return;
            }
            assigneeList.push(name);
            document.getElementById('newAssigneeName').value = '';
            renderAssigneeList();
            updateAssigneeFilter();
        }

        function removeAssignee(name) {
            if (confirm(`Remove "${name}" from assignee list?\n\nNote: This won't remove them from existing tasks.`)) {
                assigneeList = assigneeList.filter(a => a !== name);
                renderAssigneeList();
                updateAssigneeFilter();
            }
        }

        function closeAssigneeModal() {
            document.getElementById('assigneeModal').classList.remove('active');
        }

        function calculateCriticalPath() {
            criticalPath = [];
            if (tasks.length === 0) return;

            const taskMap = {};
            tasks.forEach(t => {
                taskMap[t.id] = {
                    ...t,
                    earlyStart: 0,
                    earlyFinish: 0,
                    lateStart: Infinity,
                    lateFinish: Infinity,
                    slack: 0
                };
            });

            // Forward pass
            tasks.forEach(task => {
                const t = taskMap[task.id];
                if (task.dependencies && task.dependencies.length > 0) {
                    let maxFinish = 0;
                    task.dependencies.forEach(depId => {
                        const dep = taskMap[depId];
                        if (dep) {
                            maxFinish = Math.max(maxFinish, dep.earlyFinish);
                        }
                    });
                    t.earlyStart = maxFinish;
                } else {
                    const dayOffset = Math.floor((new Date(task.start) - startDate) / (1000 * 60 * 60 * 24));
                    t.earlyStart = dayOffset;
                }
                t.earlyFinish = t.earlyStart + (task.duration || 1);
            });

            // Find project end
            const projectEnd = Math.max(...Object.values(taskMap).map(t => t.earlyFinish));

            // Backward pass
            const reverseTasks = [...tasks].reverse();
            reverseTasks.forEach(task => {
                const t = taskMap[task.id];
                
                const dependentTasks = tasks.filter(dt => 
                    dt.dependencies && dt.dependencies.includes(task.id)
                );
                
                if (dependentTasks.length === 0) {
                    t.lateFinish = projectEnd;
                } else {
                    t.lateFinish = Math.min(...dependentTasks.map(dt => taskMap[dt.id].lateStart));
                }
                t.lateStart = t.lateFinish - (task.duration || 1);
                t.slack = t.lateStart - t.earlyStart;
            });

            // Find critical path (tasks with zero slack)
            criticalPath = tasks.filter(task => {
                const t = taskMap[task.id];
                return Math.abs(t.slack) < 0.01;
            }).map(t => t.id);
        }

        function toggleCriticalPath() {
            showCritical = !showCritical;
            const btn = document.getElementById('criticalPathBtn');
            btn.textContent = showCritical ? 'Hide Critical Path' : 'Show Critical Path';
            btn.style.background = showCritical ? '#e74c3c' : '#3498db';
            render();
        }

        function updateStats() {
            const total = tasks.filter(t => t.type !== 'milestone').length;
            const completed = tasks.filter(t => t.type !== 'milestone' && t.progress === 100).length;
            const inProgress = tasks.filter(t => t.type !== 'milestone' && t.progress > 0 && t.progress < 100).length;
            const avgProgress = total > 0 ? Math.round(tasks.filter(t => t.type !== 'milestone').reduce((sum, t) => sum + (t.progress || 0), 0) / total) : 0;
            
            let minDate = null, maxDate = null;
            tasks.forEach(t => {
                if (t.type === 'milestone') return;
                const start = new Date(t.start);
                const end = new Date(start);
                end.setDate(end.getDate() + (t.duration || 1));
                
                if (!minDate || start < minDate) minDate = start;
                if (!maxDate || end > maxDate) maxDate = end;
            });
            
            const duration = minDate && maxDate ? Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statInProgress').textContent = inProgress;
            document.getElementById('statAvgProgress').textContent = avgProgress + '%';
            document.getElementById('statDuration').textContent = duration + ' days';
        }

        function render() {
            renderTimelineHeader();
            renderTimelineGrid();
            renderTaskList();
        }

        function renderTimelineHeader() {
            const header = document.getElementById('timelineHeader');
            const totalDays = numWeeks * 7;
            
            let weekHTML = '<div class="week-header">';
            let dayHTML = '<div class="day-header">';
            
            for (let w = 0; w < numWeeks; w++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + w * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                weekHTML += `<div class="week-cell">${formatDate(weekStart)} - ${formatDate(weekEnd)}</div>`;
                
                for (let d = 0; d < 7; d++) {
                    const day = new Date(weekStart);
                    day.setDate(weekStart.getDate() + d);
                    const dayLetter = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][day.getDay()];
                    dayHTML += `<div class="day-cell">${dayLetter}</div>`;
                }
            }
            
            weekHTML += '</div>';
            dayHTML += '</div>';
            header.innerHTML = weekHTML + dayHTML;
        }

        function renderTimelineGrid() {
            const grid = document.getElementById('timelineGrid');
            const totalDays = numWeeks * 7;
            
            grid.innerHTML = '';

            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '1';
            
            filteredTasks.forEach((task, index) => {
                // Skip if not visible (parent is collapsed)
                if (!isTaskVisible(task)) {
                    return;
                }
                
                if (task.type !== 'milestone') {
                    const row = document.createElement('div');
                    row.className = 'grid-row';
                    
                    for (let d = 0; d < totalDays; d++) {
                        const cellDate = new Date(startDate);
                        cellDate.setDate(startDate.getDate() + d);
                        const isWeekend = cellDate.getDay() === 0 || cellDate.getDay() === 6;
                        
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell' + (isWeekend ? ' weekend' : '');
                        row.appendChild(cell);
                    }
                    
                    const bar = createTaskBar(task, index);
                    row.appendChild(bar);
                    
                    grid.appendChild(row);
                }
            });

            // Draw dependency lines
            filteredTasks.forEach((task, index) => {
                if (task.dependencies && task.dependencies.length > 0) {
                    task.dependencies.forEach(depId => {
                        const depTask = tasks.find(t => t.id === depId);
                        if (depTask && filteredTasks.includes(task) && filteredTasks.includes(depTask)) {
                            const depIndex = filteredTasks.indexOf(depTask);
                            const taskIndex = filteredTasks.indexOf(task);
                            
                            const depRow = getTaskRowIndex(tasks.indexOf(depTask));
                            const taskRow = getTaskRowIndex(tasks.indexOf(task));
                            
                            if (depRow >= 0 && taskRow >= 0) {
                                const depEnd = Math.floor((new Date(depTask.start) - startDate) / (1000 * 60 * 60 * 24)) + (depTask.duration || 1);
                                const taskStart = Math.floor((new Date(task.start) - startDate) / (1000 * 60 * 60 * 24));
                                
                                const x1 = depEnd * dayWidth;
                                const y1 = depRow * 50 + 25;
                                const x2 = taskStart * dayWidth;
                                const y2 = taskRow * 50 + 25;
                                
                                const line = document.createElementNS(svgNS, "path");
                                const midX = (x1 + x2) / 2;
                                const d = `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`;
                                line.setAttribute("d", d);
                                line.setAttribute("class", showCritical && criticalPath.includes(task.id) && criticalPath.includes(depId) ? "dependency-line critical" : "dependency-line");
                                svg.appendChild(line);
                            }
                        }
                    });
                }
            });

            grid.appendChild(svg);

            // Render milestones and deadline
            const milestoneRow = document.createElement('div');
            milestoneRow.style.position = 'absolute';
            milestoneRow.style.width = '100%';
            milestoneRow.style.height = '100%';
            milestoneRow.style.top = '0';
            milestoneRow.style.pointerEvents = 'none';
            milestoneRow.style.zIndex = '2';

            filteredTasks.forEach((task, index) => {
                if (task.type === 'milestone') {
                    const dayOffset = Math.floor((new Date(task.start) - startDate) / (1000 * 60 * 60 * 24));
                    const rowIndex = getTaskRowIndex(tasks.indexOf(task));
                    
                    if (dayOffset >= 0 && dayOffset < totalDays && rowIndex >= 0) {
                        const milestone = document.createElement('div');
                        milestone.className = 'task-bar milestone';
                        milestone.style.left = `${dayOffset * dayWidth + 10}px`;
                        milestone.style.top = `${rowIndex * 50 + 15}px`;
                        milestone.style.pointerEvents = 'auto';
                        milestone.title = task.name;
                        milestone.addEventListener('mousedown', (e) => startDrag(e, task, tasks.indexOf(task)));
                        milestoneRow.appendChild(milestone);
                    }
                }
            });

            // Today line
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayOffset = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            if (todayOffset >= 0 && todayOffset < totalDays) {
                const todayLine = document.createElement('div');
                todayLine.className = 'task-bar today-line';
                todayLine.style.left = `${todayOffset * dayWidth}px`;
                todayLine.style.top = '0';
                todayLine.style.height = `${grid.scrollHeight}px`;
                todayLine.title = `Today: ${formatDate(today)}`;
                milestoneRow.appendChild(todayLine);
            }

            if (deadline) {
                const dayOffset = Math.floor((new Date(deadline) - startDate) / (1000 * 60 * 60 * 24));
                if (dayOffset >= 0 && dayOffset < totalDays) {
                    const deadlineMark = document.createElement('div');
                    deadlineMark.className = 'task-bar deadline';
                    deadlineMark.style.left = `${dayOffset * dayWidth}px`;
                    deadlineMark.style.top = '0';
                    deadlineMark.style.height = `${grid.scrollHeight}px`;
                    deadlineMark.title = `Deadline: ${formatDate(new Date(deadline))}`;
                    milestoneRow.appendChild(deadlineMark);
                }
            }

            grid.appendChild(milestoneRow);
        }

        function getTaskRowIndex(taskIndex) {
            let rowIndex = 0;
            for (let i = 0; i < taskIndex; i++) {
                if (isTaskVisible(tasks[i]) && filteredTasks.includes(tasks[i]) && tasks[i].type !== 'milestone') {
                    rowIndex++;
                }
            }
            
            return (isTaskVisible(tasks[taskIndex]) && filteredTasks.includes(tasks[taskIndex])) ? rowIndex : -1;
        }

        function createTaskBar(task, index) {
            const dayOffset = Math.floor((new Date(task.start) - startDate) / (1000 * 60 * 60 * 24));
            const duration = task.duration || 1;
            
            const bar = document.createElement('div');
            bar.className = `task-bar ${task.type}`;
            if (showCritical && criticalPath.includes(task.id)) {
                bar.classList.add('critical');
            }
            if (task.priority === 'high' && !showCritical) {
                bar.classList.add('high-priority');
            }
            
            bar.style.left = `${dayOffset * dayWidth}px`;
            bar.style.width = `${duration * dayWidth}px`;
            if (task.color && task.type !== 'parent') {
                bar.style.background = task.color;
            }
            
            let tooltipText = `${task.name}\nStart: ${formatDate(new Date(task.start))}\nDuration: ${duration} days`;
            if (task.assignee) tooltipText += `\nAssignee: ${task.assignee}`;
            if (task.progress !== undefined) tooltipText += `\nProgress: ${task.progress}%`;
            if (task.priority) tooltipText += `\nPriority: ${task.priority}`;
            
            bar.title = tooltipText;
            
            bar.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) return;
                startDrag(e, task, tasks.indexOf(task));
            });

            // Progress bar
            if (task.progress > 0 && task.type !== 'parent') {
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                progressBar.style.width = `${task.progress}%`;
                bar.appendChild(progressBar);
            }

            if (task.type !== 'parent') {
                const leftHandle = document.createElement('div');
                leftHandle.className = 'resize-handle left';
                leftHandle.addEventListener('mousedown', (e) => startResize(e, task, tasks.indexOf(task), 'left'));
                bar.appendChild(leftHandle);

                const rightHandle = document.createElement('div');
                rightHandle.className = 'resize-handle right';
                rightHandle.addEventListener('mousedown', (e) => startResize(e, task, tasks.indexOf(task), 'right'));
                bar.appendChild(rightHandle);
            }
            
            return bar;
        }

        function renderTaskList() {
            const taskListBody = document.getElementById('taskListBody');
            taskListBody.innerHTML = '';
            
            filteredTasks.forEach((task, index) => {
                // Skip if not visible (parent is collapsed)
                if (!isTaskVisible(task)) {
                    return;
                }

                const row = document.createElement('div');
                row.className = 'task-row';
                
                const indent = task.parentId ? '<span class="task-indent"></span>' : '';
                const toggle = task.type === 'parent' 
                    ? `<span class="task-toggle" onclick="toggleCollapse(${task.id})">${task.collapsed ? '‚ñ∂' : '‚ñº'}</span>`
                    : '<span class="task-indent"></span>';
                
                const icon = getTaskIcon(task.type);
                const priorityDot = task.priority ? `<span class="priority-indicator priority-${task.priority}"></span>` : '';
                
                const actualIndex = tasks.indexOf(task);
                const metaInfo = [];
                if (task.assignee) metaInfo.push(`üë§ ${task.assignee}`);
                if (task.progress !== undefined) metaInfo.push(`${task.progress}%`);
                const metaHTML = metaInfo.length > 0 ? `<div class="task-meta">${metaInfo.join(' ‚Ä¢ ')}</div>` : '';
                
                row.innerHTML = `
                    ${indent}
                    ${toggle}
                    ${priorityDot}
                    <span class="task-icon">${icon}</span>
                    <span class="task-name" ondblclick="editTask(${task.id})">
                        <div class="task-main-name">${task.name}</div>
                        ${metaHTML}
                    </span>
                    <div class="move-buttons">
                        <button class="move-btn" onclick="moveTask(${actualIndex}, -1)" ${actualIndex === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="move-btn" onclick="moveTask(${actualIndex}, 1)" ${actualIndex === tasks.length - 1 ? 'disabled' : ''}>‚Üì</button>
                    </div>
                    <button class="task-delete" onclick="deleteTask(${task.id})">√ó</button>
                `;
                
                taskListBody.appendChild(row);
            });
        }

        function getTaskIcon(type) {
            switch(type) {
                case 'parent': return 'üìÅ';
                case 'child': return 'üìÑ';
                case 'milestone': return 'üèÅ';
                default: return 'üìÑ';
            }
        }

        function moveTask(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= tasks.length) return;
            
            const temp = tasks[index];
            tasks[index] = tasks[newIndex];
            tasks[newIndex] = temp;
            
            applyFilters();
        }

        function startDrag(e, task, index) {
            e.preventDefault();
            e.stopPropagation();
            draggedTask = { task, index };
            dragStartX = e.clientX;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function drag(e) {
            if (!draggedTask) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaDays = Math.round(deltaX / dayWidth);
            
            if (deltaDays !== 0) {
                const newStart = new Date(draggedTask.task.start);
                newStart.setDate(newStart.getDate() + deltaDays);
                draggedTask.task.start = newStart.toISOString().split('T')[0];
                dragStartX = e.clientX;
                render();
            }
        }

        function stopDrag() {
            draggedTask = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function startResize(e, task, index, direction) {
            e.preventDefault();
            e.stopPropagation();
            resizeTask = { task, index };
            resizeDirection = direction;
            dragStartX = e.clientX;
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        }

        function resize(e) {
            if (!resizeTask) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaDays = Math.round(deltaX / dayWidth);
            
            if (deltaDays !== 0) {
                if (resizeDirection === 'left') {
                    const newStart = new Date(resizeTask.task.start);
                    newStart.setDate(newStart.getDate() + deltaDays);
                    resizeTask.task.start = newStart.toISOString().split('T')[0];
                    resizeTask.task.duration = Math.max(1, resizeTask.task.duration - deltaDays);
                } else {
                    resizeTask.task.duration = Math.max(1, resizeTask.task.duration + deltaDays);
                }
                dragStartX = e.clientX;
                render();
            }
        }

        function stopResize() {
            resizeTask = null;
            resizeDirection = null;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }

        function toggleCollapse(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.collapsed = !task.collapsed;
                applyFilters();
            }
        }

        function addTask() {
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Add Task';
            document.getElementById('modalTaskName').value = '';
            document.getElementById('modalTaskType').value = 'child';
            document.getElementById('modalStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('modalDuration').value = 3;
            document.getElementById('modalProgress').value = 0;
            updateAssigneeSelect();
            document.getElementById('modalAssigneeCustom').value = '';
            document.getElementById('modalPriority').value = 'medium';
            document.getElementById('modalColor').value = '#3498db';
            updateColorPreview();
            updateParentSelect();
            updateDependencySelect();
            document.getElementById('taskModal').classList.add('active');
        }

        function addMilestone() {
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Add Milestone';
            document.getElementById('modalTaskName').value = '';
            document.getElementById('modalTaskType').value = 'milestone';
            document.getElementById('modalStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('modalDuration').value = 1;
            document.getElementById('modalProgress').value = 0;
            updateAssigneeSelect();
            document.getElementById('modalAssigneeCustom').value = '';
            document.getElementById('modalPriority').value = 'high';
            document.getElementById('modalColor').value = '#e74c3c';
            updateColorPreview();
            updateParentSelect();
            updateDependencySelect();
            document.getElementById('taskModal').classList.add('active');
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            editingTaskId = taskId;
            document.getElementById('modalTitle').textContent = 'Edit Task';
            document.getElementById('modalTaskName').value = task.name;
            document.getElementById('modalTaskType').value = task.type;
            document.getElementById('modalStartDate').value = task.start;
            document.getElementById('modalDuration').value = task.duration || 1;
            document.getElementById('modalProgress').value = task.progress || 0;
            updateAssigneeSelect();
            document.getElementById('modalAssignee').value = task.assignee || '';
            document.getElementById('modalAssigneeCustom').value = '';
            document.getElementById('modalPriority').value = task.priority || 'medium';
            document.getElementById('modalColor').value = task.color || '#3498db';
            updateColorPreview();
            updateParentSelect();
            updateDependencySelect();
            document.getElementById('modalParent').value = task.parentId || '';
            
            const depSelect = document.getElementById('modalDependencies');
            Array.from(depSelect.options).forEach(opt => {
                opt.selected = task.dependencies && task.dependencies.includes(parseInt(opt.value));
            });
            
            document.getElementById('taskModal').classList.add('active');
        }

        function updateAssigneeSelect() {
            const select = document.getElementById('modalAssignee');
            const allAssignees = [...new Set([...assigneeList, ...tasks.map(t => t.assignee).filter(Boolean)])];
            
            select.innerHTML = '<option value="">None</option>';
            allAssignees.forEach(assignee => {
                select.innerHTML += `<option value="${assignee}">${assignee}</option>`;
            });
        }

        function updateParentSelect() {
            const select = document.getElementById('modalParent');
            select.innerHTML = '<option value="">None</option>';
            tasks.filter(t => t.type === 'parent').forEach(t => {
                if (editingTaskId !== t.id) {
                    select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                }
            });
        }
        
        function isTaskVisible(task) {
            // Check if task should be visible based on parent collapse state
            if (!task.parentId) return true;
            
            const parent = tasks.find(t => t.id === task.parentId);
            if (!parent) return true;
            
            if (parent.collapsed) return false;
            
            // Recursively check if parent is visible
            return isTaskVisible(parent);
        }

        function updateDependencySelect() {
            const select = document.getElementById('modalDependencies');
            select.innerHTML = '';
            tasks.forEach(t => {
                if (editingTaskId !== t.id && t.type !== 'milestone') {
                    select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                }
            });
        }

        function updateColorPreview() {
            const color = document.getElementById('modalColor').value;
            document.getElementById('colorPreview').style.background = color;
        }

        document.getElementById('modalColor').addEventListener('input', updateColorPreview);

        function saveTask() {
            const name = document.getElementById('modalTaskName').value;
            const type = document.getElementById('modalTaskType').value;
            const start = document.getElementById('modalStartDate').value;
            const duration = parseInt(document.getElementById('modalDuration').value) || 1;
            const progress = parseInt(document.getElementById('modalProgress').value) || 0;
            const assigneeSelect = document.getElementById('modalAssignee').value;
            const assigneeCustom = document.getElementById('modalAssigneeCustom').value.trim();
            const assignee = assigneeCustom || assigneeSelect || null;
            const priority = document.getElementById('modalPriority').value;
            const color = document.getElementById('modalColor').value;
            const parentId = document.getElementById('modalParent').value || null;
            
            const depSelect = document.getElementById('modalDependencies');
            const dependencies = Array.from(depSelect.selectedOptions).map(opt => parseInt(opt.value));
            
            if (!name) {
                alert('Please enter a task name');
                return;
            }
            
            // Add custom assignee to list if new
            if (assigneeCustom && !assigneeList.includes(assigneeCustom)) {
                assigneeList.push(assigneeCustom);
            }
            
            if (editingTaskId !== null) {
                const task = tasks.find(t => t.id === editingTaskId);
                if (task) {
                    task.name = name;
                    task.type = type;
                    task.start = start;
                    task.duration = duration;
                    task.progress = progress;
                    task.assignee = assignee;
                    task.priority = priority;
                    task.color = color;
                    task.parentId = parentId;
                    task.dependencies = dependencies;
                }
            } else {
                const newTask = {
                    id: Date.now(),
                    name,
                    type,
                    start,
                    duration,
                    progress,
                    assignee,
                    priority,
                    color,
                    parentId,
                    dependencies,
                    collapsed: false
                };
                tasks.push(newTask);
            }
            
            closeModal();
            applyFilters();
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => {
                    if (t.id === taskId || t.parentId === taskId) return false;
                    if (t.dependencies) {
                        t.dependencies = t.dependencies.filter(d => d !== taskId);
                    }
                    return true;
                });
                applyFilters();
            }
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
        }

        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        function setDeadline() {
            const date = prompt('Enter deadline date (YYYY-MM-DD):', deadline || '');
            if (date) {
                deadline = date;
                render();
            } else if (date === '') {
                deadline = null;
                render();
            }
        }

        function saveProject() {
            const project = {
                startDate: startDate.toISOString().split('T')[0],
                numWeeks,
                tasks,
                deadline,
                assigneeList
            };
            
            const json = JSON.stringify(project, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gantt-project.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadProject() {
            document.getElementById('fileInput').click();
        }

        function exportToPNG() {
            const container = document.querySelector('.container');
            const ganttWrapper = document.querySelector('.gantt-wrapper');
            
            // Store original styles
            const originalMaxHeight = ganttWrapper.style.maxHeight;
            const originalOverflow = ganttWrapper.style.overflow;
            
            // Temporarily expand to full size for capture
            ganttWrapper.style.maxHeight = 'none';
            ganttWrapper.style.overflow = 'visible';
            
            // Use html2canvas library
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = () => {
                html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true
                }).then(canvas => {
                    // Restore original styles
                    ganttWrapper.style.maxHeight = originalMaxHeight;
                    ganttWrapper.style.overflow = originalOverflow;
                    
                    // Download the image
                    canvas.toBlob(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `gantt-chart-${new Date().toISOString().split('T')[0]}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                }).catch(err => {
                    // Restore original styles even on error
                    ganttWrapper.style.maxHeight = originalMaxHeight;
                    ganttWrapper.style.overflow = originalOverflow;
                    alert('Error exporting PNG: ' + err.message);
                });
            };
            script.onerror = () => {
                ganttWrapper.style.maxHeight = originalMaxHeight;
                ganttWrapper.style.overflow = originalOverflow;
                alert('Failed to load export library. Please check your internet connection.');
            };
            document.head.appendChild(script);
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const project = JSON.parse(e.target.result);
                    startDate = new Date(project.startDate);
                    numWeeks = project.numWeeks;
                    tasks = project.tasks || [];
                    deadline = project.deadline;
                    assigneeList = project.assigneeList || [];
                    
                    document.getElementById('startDate').value = project.startDate;
                    document.getElementById('numWeeks').value = project.numWeeks;
                    
                    applyFilters();
                } catch (err) {
                    alert('Error loading project file: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        // Initialize
        initializeDate();
        updateTimeline();
    </script>
</body>
</html>
