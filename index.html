<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Gantt Chart Builder Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar h1 {
            font-size: 20px;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar .credit {
            font-size: 10px;
            opacity: 0.6;
            font-weight: normal;
            font-style: italic;
        }

        .toolbar button, .toolbar input {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .toolbar button {
            background: #3498db;
            color: white;
            transition: background 0.3s;
        }

        .toolbar button:hover {
            background: #2980b9;
        }

        .toolbar input[type="date"], .toolbar input[type="number"] {
            padding: 7px 10px;
        }

        .toolbar label {
            font-size: 14px;
        }

        .stats-bar {
            background: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            opacity: 0.8;
        }

        .stat-value {
            font-weight: bold;
            font-size: 14px;
        }

        .filter-bar {
            background: #ecf0f1;
            padding: 12px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 2px solid #bdc3c7;
        }

        .filter-bar input, .filter-bar select {
            padding: 6px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
        }

        .filter-bar label {
            font-size: 13px;
            font-weight: 500;
        }

        .gantt-wrapper {
            display: flex;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 60vh;
        }

        .task-list {
            min-width: 350px;
            background: #ecf0f1;
            border-right: 2px solid #bdc3c7;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .task-list-header {
            background: #34495e;
            color: white;
            padding: 12px;
            font-weight: bold;
            border-bottom: 2px solid #2c3e50;
            height: 80px;
            display: flex;
            align-items: center;
        }

        .task-row {
            padding: 8px 12px;
            border-bottom: 1px solid #bdc3c7;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 50px;
            background: white;
            position: relative;
        }

        .task-row:hover {
            background: #f8f9fa;
        }

        .task-row:hover .move-buttons {
            display: flex;
        }

        .task-indent {
            width: 20px;
        }

        .task-toggle {
            cursor: pointer;
            user-select: none;
            width: 16px;
            text-align: center;
            color: #3498db;
            font-weight: bold;
        }

        .task-name {
            flex: 1;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            cursor: pointer;
        }

        .task-main-name {
            font-weight: 500;
        }

        .task-meta {
            font-size: 11px;
            color: #7f8c8d;
            display: flex;
            gap: 10px;
        }

        .task-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .task-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        .priority-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .priority-low { background: #95a5a6; }
        .priority-medium { background: #f39c12; }
        .priority-high { background: #e74c3c; }

        .move-buttons {
            display: none;
            gap: 2px;
            margin-left: auto;
        }

        .move-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .move-btn:hover {
            background: #2980b9;
        }

        .timeline {
            flex: 1;
            overflow-x: auto;
            min-width: 0;
        }

        .timeline-header {
            display: flex;
            background: #34495e;
            color: white;
            border-bottom: 2px solid #2c3e50;
            height: 80px;
            flex-direction: column;
            position: sticky;
            top: 0;
            z-index: 5;
            min-width: min-content;
        }

        .week-header, .day-header {
            min-width: min-content;
        }

        .week-header {
            display: flex;
            height: 40px;
        }

        .week-cell {
            min-width: 140px;
            padding: 8px;
            border-right: 1px solid #2c3e50;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-header {
            display: flex;
            height: 40px;
        }

        .day-cell {
            min-width: 20px;
            padding: 4px;
            border-right: 1px solid #4a5f7f;
            text-align: center;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-grid {
            position: relative;
            min-width: min-content;
        }

        .grid-row {
            display: flex;
            height: 50px;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
            min-width: min-content;
        }

        .grid-cell {
            min-width: 20px;
            border-right: 1px solid #ecf0f1;
        }

        .grid-cell.weekend {
            background: #f8f9fa;
        }

        .task-bar {
            position: absolute;
            height: 28px;
            top: 11px;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            color: white;
            font-weight: 500;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }

        .task-bar.parent {
            background: #2c3e50;
            height: 8px;
            top: 21px;
            border-radius: 2px;
        }

        .task-bar.child {
            background: #3498db;
        }

        .task-bar.critical {
            background: #e74c3c;
            border: 2px solid #c0392b;
        }

        .task-bar.high-priority {
            border: 2px solid #e74c3c;
        }

        .task-bar.milestone {
            width: 20px !important;
            height: 20px;
            background: #e74c3c;
            transform: rotate(45deg);
            top: 15px;
            padding: 0;
            cursor: pointer;
        }

        .task-bar.deadline {
            width: 3px !important;
            height: 100%;
            background: #e74c3c;
            top: 0;
            padding: 0;
            border-radius: 0;
            z-index: 4;
        }

        .today-line {
            width: 2px !important;
            height: 100%;
            background: #27ae60;
            top: 0;
            padding: 0;
            border-radius: 0;
            box-shadow: 0 0 5px rgba(39, 174, 96, 0.5);
            z-index: 4;
        }

        .progress-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px 0 0 4px;
            pointer-events: none;
        }

        .resize-handle {
            position: absolute;
            width: 8px;
            height: 100%;
            top: 0;
            cursor: ew-resize;
            background: rgba(255,255,255,0.3);
        }

        .resize-handle.left { left: 0; }
        .resize-handle.right { right: 0; }

        .dependency-line {
            position: absolute;
            stroke: #95a5a6;
            stroke-width: 2;
            fill: none;
            pointer-events: none;
        }

        .dependency-line.critical {
            stroke: #e74c3c;
            stroke-width: 3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
        }

        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-buttons .save { background: #27ae60; color: white; }
        .modal-buttons .cancel { background: #95a5a6; color: white; }

        .help-content { line-height: 1.6; }
        .help-content h3 { margin-top: 15px; margin-bottom: 10px; color: #2c3e50; }
        .help-content ul { margin-left: 20px; margin-bottom: 10px; }
        .help-content li { margin-bottom: 5px; }

        select[multiple] { min-height: 100px; }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #bdc3c7;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <h1>üìä Gantt Chart Builder Pro <span class="credit">Parmiters School Computing Dept</span></h1>
            <label>Start Date:</label>
            <input type="date" id="startDate">
            <label>Weeks:</label>
            <input type="number" id="numWeeks" value="8" min="1" max="52" style="width: 60px;">
            <button onclick="updateTimeline()">Update Timeline</button>
            <button onclick="addTask()">+ Add Task</button>
            <button onclick="addMilestone()">+ Add Milestone</button>
            <button onclick="setDeadline()">Set Deadline</button>
            <button onclick="toggleCriticalPath()" id="criticalPathBtn">Show Critical Path</button>
            <button onclick="manageAssignees()">üë• Manage Assignees</button>
            <button onclick="saveProject()">üíæ Save JSON</button>
            <button onclick="loadProject()">üìÇ Load JSON</button>
            <button onclick="exportToPNG()">üì∑ Export PNG</button>
            <button onclick="showHelp()">‚ùì Help</button>
        </div>

        <div class="stats-bar">
            <div class="stat-item"><span class="stat-label">Total Tasks:</span> <span class="stat-value" id="statTotal">0</span></div>
            <div class="stat-item"><span class="stat-label">Completed:</span> <span class="stat-value" id="statCompleted">0</span></div>
            <div class="stat-item"><span class="stat-label">In Progress:</span> <span class="stat-value" id="statInProgress">0</span></div>
            <div class="stat-item"><span class="stat-label">Avg Progress:</span> <span class="stat-value" id="statAvgProgress">0%</span></div>
            <div class="stat-item"><span class="stat-label">Duration:</span> <span class="stat-value" id="statDuration">0 days</span></div>
        </div>

        <div class="filter-bar">
            <label>üîç Search:</label>
            <input type="text" id="searchFilter" placeholder="Search tasks..." oninput="applyFilters()">
            <label>üë§ Assignee:</label>
            <select id="assigneeFilter" onchange="applyFilters()"><option value="">All</option></select>
            <label>‚ö° Priority:</label>
            <select id="priorityFilter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
        </div>

        <div class="gantt-wrapper">
            <div class="task-list">
                <div class="task-list-header">Task Details</div>
                <div id="taskListBody"></div>
            </div>
            <div class="timeline">
                <div class="timeline-header" id="timelineHeader"></div>
                <div class="timeline-grid" id="timelineGrid"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Task</h2>
            <label>Task Name:</label>
            <input type="text" id="modalTaskName">
            <label>Type:</label>
            <select id="modalTaskType">
                <option value="child">Child Task</option>
                <option value="parent">Parent Task</option>
                <option value="milestone">Milestone</option>
            </select>
            <label>Start Date:</label>
            <input type="date" id="modalStartDate">
            <label>Duration (days):</label>
            <input type="number" id="modalDuration" value="3" min="1">
            <label>Progress (%):</label>
            <input type="number" id="modalProgress" value="0" min="0" max="100">
            <label>Assignee:</label>
            <select id="modalAssignee"><option value="">None</option></select>
            <input type="text" id="modalAssigneeCustom" placeholder="Or type new assignee name" style="margin-top: 5px;">
            <label>Priority:</label>
            <select id="modalPriority">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
            <label>Custom Color:</label>
            <input type="color" id="modalColor" value="#3498db">
            <span class="color-preview" id="colorPreview"></span>
            <label>Parent Task (optional):</label>
            <select id="modalParent"><option value="">None</option></select>
            <label>Dependencies (must finish before this one):</label>
            <select id="modalDependencies" multiple></select>
            <button type="button" onclick="clearDependencies()" style="margin-top: 5px; font-size: 11px; padding: 4px; background: #eee; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;">Clear Dependencies (No dependency)</button>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeModal()">Cancel</button>
                <button class="save" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="helpModal">
        <div class="modal-content">
            <h2>Gantt Chart Pro - User Guide</h2>
            <div class="help-content">
                <h3>Key Features</h3>
                <ul>
                    <li><strong>Expand/Collapse:</strong> Manage large projects by grouping tasks.</li>
                    <li><strong>Dependencies:</strong> Grey lines show task relationships.</li>
                    <li><strong>Critical Path:</strong> Longest task chain highlighted in red.</li>
                    <li><strong>Milestones:</strong> Track key project dates on their own rows.</li>
                </ul>
            </div>
            <div class="modal-buttons"><button class="cancel" onclick="closeHelp()">Close</button></div>
        </div>
    </div>

    <div class="modal" id="assigneeModal">
        <div class="modal-content">
            <h2>Manage Team Assignees</h2>
            <div style="margin-bottom: 15px;">
                <label>Add New Assignee:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newAssigneeName" placeholder="Enter name" style="flex: 1;">
                    <button onclick="addAssignee()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Add</button>
                </div>
            </div>
            <div id="assigneeList" style="max-height: 300px; overflow-y: auto; border: 1px solid #bdc3c7; border-radius: 4px; padding: 10px;"></div>
            <div class="modal-buttons"><button class="cancel" onclick="closeAssigneeModal()">Close</button></div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" accept=".json">

    <script>
        let startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        let numWeeks = 8;
        let tasks = [];
        let deadline = null;
        let draggedTask = null;
        let resizeTask = null;
        let resizeDirection = null;
        let dragStartX = 0;
        let editingTaskId = null;
        let showCritical = false;
        let criticalPath = [];
        let displayedTasks = []; // Consolidated tasks (filtered + visibility logic applied)
        let assigneeList = [];

        const dayWidth = 20;

        function initializeDate() {
            const dateInput = document.getElementById('startDate');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dateInput.value = today.toISOString().split('T')[0];
            startDate = new Date(today);
        }

        function updateTimeline() {
            const dateInput = document.getElementById('startDate').value;
            if (dateInput) {
                startDate = new Date(dateInput);
                startDate.setHours(0, 0, 0, 0);
            }
            numWeeks = parseInt(document.getElementById('numWeeks').value) || 8;
            applyFilters();
        }

        function isTaskVisible(task) {
            if (!task.parentId) return true;
            const parent = tasks.find(t => t.id === parseInt(task.parentId));
            if (!parent) return true;
            if (parent.collapsed) return false;
            return isTaskVisible(parent);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const assigneeFilter = document.getElementById('assigneeFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;

            // Step 1: Filter by metadata
            let filtered = tasks.filter(task => {
                const matchesSearch = task.name.toLowerCase().includes(searchTerm) || 
                                    (task.assignee && task.assignee.toLowerCase().includes(searchTerm));
                const matchesAssignee = !assigneeFilter || task.assignee === assigneeFilter;
                const matchesPriority = !priorityFilter || task.priority === priorityFilter;
                return matchesSearch && matchesAssignee && matchesPriority;
            });

            // Step 2: Filter by visibility (expand/collapse)
            displayedTasks = filtered.filter(task => isTaskVisible(task));

            updateAssigneeFilter();
            calculateCriticalPath();
            updateStats();
            render();
        }

        function updateAssigneeFilter() {
            const select = document.getElementById('assigneeFilter');
            const currentValue = select.value;
            const assignees = [...new Set([...assigneeList, ...tasks.map(t => t.assignee).filter(Boolean)])];
            select.innerHTML = '<option value="">All</option>';
            assignees.forEach(assignee => {
                select.innerHTML += `<option value="${assignee}">${assignee}</option>`;
            });
            select.value = currentValue;
        }

        function manageAssignees() {
            renderAssigneeList();
            document.getElementById('assigneeModal').classList.add('active');
        }

        function renderAssigneeList() {
            const listDiv = document.getElementById('assigneeList');
            if (assigneeList.length === 0) {
                listDiv.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No assignees added yet</p>';
            } else {
                listDiv.innerHTML = assigneeList.map(assignee => `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #ecf0f1; gap: 10px;">
                        <span style="flex: 1; font-size: 14px;">${assignee}</span>
                        <button onclick="removeAssignee('${assignee}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">Remove</button>
                    </div>
                `).join('');
            }
        }

        function addAssignee() {
            const name = document.getElementById('newAssigneeName').value.trim();
            if (!name || assigneeList.includes(name)) return;
            assigneeList.push(name);
            document.getElementById('newAssigneeName').value = '';
            renderAssigneeList();
            updateAssigneeFilter();
        }

        function removeAssignee(name) {
            assigneeList = assigneeList.filter(a => a !== name);
            renderAssigneeList();
            updateAssigneeFilter();
        }

        function closeAssigneeModal() { document.getElementById('assigneeModal').classList.remove('active'); }

        function calculateCriticalPath() {
            criticalPath = [];
            if (tasks.length === 0) return;
            const taskMap = {};
            tasks.forEach(t => {
                taskMap[t.id] = { ...t, earlyStart: 0, earlyFinish: 0, lateStart: Infinity, lateFinish: Infinity, slack: 0 };
            });
            tasks.forEach(task => {
                const t = taskMap[task.id];
                if (task.dependencies && task.dependencies.length > 0) {
                    let maxFinish = 0;
                    task.dependencies.forEach(depId => { if (taskMap[depId]) maxFinish = Math.max(maxFinish, taskMap[depId].earlyFinish); });
                    t.earlyStart = maxFinish;
                } else {
                    t.earlyStart = Math.floor((new Date(task.start) - startDate) / 86400000);
                }
                t.earlyFinish = t.earlyStart + (task.duration || 1);
            });
            const projectEnd = Math.max(...Object.values(taskMap).map(t => t.earlyFinish));
            [...tasks].reverse().forEach(task => {
                const t = taskMap[task.id];
                const deps = tasks.filter(dt => dt.dependencies && dt.dependencies.includes(task.id));
                if (deps.length === 0) t.lateFinish = projectEnd;
                else t.lateFinish = Math.min(...deps.map(dt => taskMap[dt.id].lateStart));
                t.lateStart = t.lateFinish - (task.duration || 1);
                t.slack = t.lateStart - t.earlyStart;
            });
            criticalPath = tasks.filter(task => Math.abs(taskMap[task.id].slack) < 0.01).map(t => t.id);
        }

        function toggleCriticalPath() {
            showCritical = !showCritical;
            const btn = document.getElementById('criticalPathBtn');
            btn.textContent = showCritical ? 'Hide Critical Path' : 'Show Critical Path';
            btn.style.background = showCritical ? '#e74c3c' : '#3498db';
            render();
        }

        function updateStats() {
            const tArray = tasks.filter(t => t.type !== 'milestone');
            const total = tArray.length;
            const completed = tArray.filter(t => t.progress === 100).length;
            const inProgress = tArray.filter(t => t.progress > 0 && t.progress < 100).length;
            const avgProgress = total > 0 ? Math.round(tArray.reduce((sum, t) => sum + (t.progress || 0), 0) / total) : 0;
            
            let minD = null, maxD = null;
            tasks.forEach(t => {
                if (t.type === 'milestone') return;
                const s = new Date(t.start);
                const e = new Date(s);
                e.setDate(s.getDate() + (t.duration || 1));
                if (!minD || s < minD) minD = s;
                if (!maxD || e > maxD) maxD = e;
            });
            const dur = minD && maxD ? Math.ceil((maxD - minD) / 86400000) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statInProgress').textContent = inProgress;
            document.getElementById('statAvgProgress').textContent = avgProgress + '%';
            document.getElementById('statDuration').textContent = dur + ' days';
        }

        function render() {
            renderTimelineHeader();
            renderTimelineGrid();
            renderTaskList();
        }

        function renderTimelineHeader() {
            const header = document.getElementById('timelineHeader');
            let weekHTML = '<div class="week-header">';
            let dayHTML = '<div class="day-header">';
            for (let w = 0; w < numWeeks; w++) {
                const ws = new Date(startDate); ws.setDate(startDate.getDate() + w * 7);
                const we = new Date(ws); we.setDate(ws.getDate() + 6);
                weekHTML += `<div class="week-cell">${formatDate(ws)} - ${formatDate(we)}</div>`;
                for (let d = 0; d < 7; d++) {
                    const day = new Date(ws); day.setDate(ws.getDate() + d);
                    dayHTML += `<div class="day-cell">${['S', 'M', 'T', 'W', 'T', 'F', 'S'][day.getDay()]}</div>`;
                }
            }
            header.innerHTML = weekHTML + '</div>' + dayHTML + '</div>';
        }

        function renderTimelineGrid() {
            const grid = document.getElementById('timelineGrid');
            const totalDays = numWeeks * 7;
            grid.innerHTML = '';

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("style", `position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1;`);
            
            displayedTasks.forEach((task, index) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                for (let d = 0; d < totalDays; d++) {
                    const cDate = new Date(startDate); cDate.setDate(startDate.getDate() + d);
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell' + (cDate.getDay() === 0 || cDate.getDay() === 6 ? ' weekend' : '');
                    row.appendChild(cell);
                }

                // Render Bar (Task OR Milestone)
                const dayOffset = Math.floor((new Date(task.start) - startDate) / 86400000);
                const bar = document.createElement('div');
                bar.className = `task-bar ${task.type}`;
                if (showCritical && criticalPath.includes(task.id)) bar.classList.add('critical');
                if (task.priority === 'high' && !showCritical) bar.classList.add('high-priority');
                
                bar.style.left = `${dayOffset * dayWidth + (task.type === 'milestone' ? 10 : 0)}px`;
                if (task.type !== 'milestone') {
                    bar.style.width = `${(task.duration || 1) * dayWidth}px`;
                    if (task.color && task.type !== 'parent') bar.style.background = task.color;
                    if (task.progress > 0 && task.type !== 'parent') {
                        const prog = document.createElement('div');
                        prog.className = 'progress-bar';
                        prog.style.width = `${task.progress}%`;
                        bar.appendChild(prog);
                    }
                    // Resize handles
                    if (task.type !== 'parent') {
                        ['left', 'right'].forEach(dir => {
                            const h = document.createElement('div');
                            h.className = `resize-handle ${dir}`;
                            h.onmousedown = (e) => startResize(e, task, tasks.indexOf(task), dir);
                            bar.appendChild(h);
                        });
                    }
                }
                
                bar.onmousedown = (e) => { if (!e.target.classList.contains('resize-handle')) startDrag(e, task, tasks.indexOf(task)); };
                row.appendChild(bar);
                grid.appendChild(row);

                // Dependencies
                if (task.dependencies) {
                    task.dependencies.forEach(depId => {
                        const dep = tasks.find(t => t.id === depId);
                        const depDispIdx = displayedTasks.findIndex(t => t.id === depId);
                        if (dep && depDispIdx >= 0) {
                            const x1 = (Math.floor((new Date(dep.start) - startDate) / 86400000) + (dep.duration || 0)) * dayWidth;
                            const y1 = depDispIdx * 50 + 25;
                            const x2 = dayOffset * dayWidth;
                            const y2 = index * 50 + 25;
                            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                            const mid = (x1 + x2) / 2;
                            path.setAttribute("d", `M ${x1} ${y1} L ${mid} ${y1} L ${mid} ${y2} L ${x2} ${y2}`);
                            path.setAttribute("class", showCritical && criticalPath.includes(task.id) && criticalPath.includes(depId) ? "dependency-line critical" : "dependency-line");
                            svg.appendChild(path);
                        }
                    });
                }
            });

            // Indicators Layer
            const indOverlay = document.createElement('div');
            indOverlay.setAttribute("style", "position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:4;");
            
            const today = new Date(); today.setHours(0,0,0,0);
            const tOff = Math.floor((today - startDate) / 86400000);
            if (tOff >= 0 && tOff < totalDays) {
                const line = document.createElement('div');
                line.className = 'today-line';
                line.style.left = `${tOff * dayWidth}px`;
                line.style.height = `${displayedTasks.length * 50}px`;
                indOverlay.appendChild(line);
            }

            if (deadline) {
                const dOff = Math.floor((new Date(deadline) - startDate) / 86400000);
                if (dOff >= 0 && dOff < totalDays) {
                    const line = document.createElement('div');
                    line.className = 'deadline';
                    line.style.left = `${dOff * dayWidth}px`;
                    line.style.height = `${displayedTasks.length * 50}px`;
                    indOverlay.appendChild(line);
                }
            }

            grid.appendChild(svg);
            grid.appendChild(indOverlay);
        }

        function renderTaskList() {
            const body = document.getElementById('taskListBody');
            body.innerHTML = '';
            displayedTasks.forEach((task, index) => {
                const row = document.createElement('div');
                row.className = 'task-row';
                const indent = task.parentId ? '<span class="task-indent"></span>' : '';
                const toggle = task.type === 'parent' ? `<span class="task-toggle" onclick="toggleCollapse(${task.id}, event)">${task.collapsed ? '‚ñ∂' : '‚ñº'}</span>` : '<span class="task-indent"></span>';
                const actualIdx = tasks.indexOf(task);
                row.innerHTML = `
                    ${indent}${toggle}
                    <span class="priority-indicator priority-${task.priority || 'medium'}"></span>
                    <span class="task-icon">${getTaskIcon(task.type)}</span>
                    <span class="task-name" onclick="editTask(${task.id})">
                        <div class="task-main-name">${task.name}</div>
                        <div class="task-meta">${task.assignee ? 'üë§ ' + task.assignee : ''} ${task.type !== 'milestone' ? '‚Ä¢ ' + (task.progress || 0) + '%' : ''}</div>
                    </span>
                    <div class="move-buttons">
                        <button class="move-btn" onclick="moveTask(${actualIdx}, -1)">‚Üë</button>
                        <button class="move-btn" onclick="moveTask(${actualIdx}, 1)">‚Üì</button>
                    </div>
                    <button class="task-delete" onclick="deleteTask(${task.id})">√ó</button>
                `;
                body.appendChild(row);
            });
        }

        function getTaskIcon(type) { return type === 'parent' ? 'üìÅ' : (type === 'milestone' ? 'üèÅ' : 'üìÑ'); }

        function moveTask(idx, dir) {
            const nIdx = idx + dir;
            if (nIdx < 0 || nIdx >= tasks.length) return;
            [tasks[idx], tasks[nIdx]] = [tasks[nIdx], tasks[idx]];
            applyFilters();
        }

        function startDrag(e, task, index) {
            e.preventDefault(); draggedTask = { task, index }; dragStartX = e.clientX;
            document.onmousemove = drag; document.onmouseup = stopDrag;
        }

        function drag(e) {
            if (!draggedTask) return;
            const diff = Math.round((e.clientX - dragStartX) / dayWidth);
            if (diff !== 0) {
                const d = new Date(draggedTask.task.start); d.setDate(d.getDate() + diff);
                draggedTask.task.start = d.toISOString().split('T')[0];
                dragStartX = e.clientX; render();
            }
        }

        function stopDrag() { draggedTask = null; document.onmousemove = null; document.onmouseup = null; }

        function startResize(e, task, index, dir) {
            e.preventDefault(); e.stopPropagation();
            resizeTask = { task, index }; resizeDirection = dir; dragStartX = e.clientX;
            document.onmousemove = resize; document.onmouseup = stopResize;
        }

        function resize(e) {
            if (!resizeTask) return;
            const diff = Math.round((e.clientX - dragStartX) / dayWidth);
            if (diff !== 0) {
                if (resizeDirection === 'left') {
                    const d = new Date(resizeTask.task.start); d.setDate(d.getDate() + diff);
                    resizeTask.task.start = d.toISOString().split('T')[0];
                    resizeTask.task.duration = Math.max(1, resizeTask.task.duration - diff);
                } else resizeTask.task.duration = Math.max(1, resizeTask.task.duration + diff);
                dragStartX = e.clientX; render();
            }
        }

        function stopResize() { resizeTask = null; document.onmousemove = null; document.onmouseup = null; }

        function toggleCollapse(id, e) {
            e.stopPropagation();
            const t = tasks.find(x => x.id === id);
            if (t) { t.collapsed = !t.collapsed; applyFilters(); }
        }

        function addTask() { openModal('child'); }
        function addMilestone() { openModal('milestone'); }

        function openModal(type, id = null) {
            editingTaskId = id;
            const t = id ? tasks.find(x => x.id === id) : null;
            document.getElementById('modalTitle').textContent = id ? 'Edit' : 'Add ' + type;
            document.getElementById('modalTaskName').value = t ? t.name : '';
            document.getElementById('modalTaskType').value = t ? t.type : type;
            document.getElementById('modalStartDate').value = t ? t.start : startDate.toISOString().split('T')[0];
            document.getElementById('modalDuration').value = t ? t.duration : (type === 'milestone' ? 1 : 3);
            document.getElementById('modalProgress').value = t ? t.progress : 0;
            document.getElementById('modalPriority').value = t ? t.priority : 'medium';
            document.getElementById('modalColor').value = t ? t.color || '#3498db' : '#3498db';
            
            updateAssigneeSelect();
            document.getElementById('modalAssignee').value = t ? t.assignee || '' : '';
            
            updateParentSelect();
            document.getElementById('modalParent').value = t ? t.parentId || '' : '';
            
            updateDependencySelect();
            const depSel = document.getElementById('modalDependencies');
            Array.from(depSel.options).forEach(o => o.selected = t && t.dependencies && t.dependencies.includes(parseInt(o.value)));
            
            document.getElementById('taskModal').classList.add('active');
        }

        function editTask(id) { openModal(null, id); }

        function updateAssigneeSelect() {
            const s = document.getElementById('modalAssignee');
            const list = [...new Set([...assigneeList, ...tasks.map(t => t.assignee).filter(Boolean)])];
            s.innerHTML = '<option value="">None</option>' + list.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function updateParentSelect() {
            const s = document.getElementById('modalParent');
            s.innerHTML = '<option value="">None</option>' + tasks.filter(t => t.type === 'parent' && t.id !== editingTaskId).map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        function updateDependencySelect() {
            const s = document.getElementById('modalDependencies');
            s.innerHTML = tasks.filter(t => t.id !== editingTaskId).map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        function clearDependencies() { document.getElementById('modalDependencies').selectedIndex = -1; }

        function saveTask() {
            const name = document.getElementById('modalTaskName').value;
            const parentId = document.getElementById('modalParent').value;
            const customA = document.getElementById('modalAssigneeCustom').value.trim();
            const assignee = customA || document.getElementById('modalAssignee').value || null;
            if (!name) return alert('Enter name');
            if (customA && !assigneeList.includes(customA)) assigneeList.push(customA);

            const data = {
                id: editingTaskId || Date.now(),
                name,
                type: document.getElementById('modalTaskType').value,
                start: document.getElementById('modalStartDate').value,
                duration: parseInt(document.getElementById('modalDuration').value) || 1,
                progress: parseInt(document.getElementById('modalProgress').value) || 0,
                priority: document.getElementById('modalPriority').value,
                color: document.getElementById('modalColor').value,
                parentId: parentId || null,
                dependencies: Array.from(document.getElementById('modalDependencies').selectedOptions).map(o => parseInt(o.value)),
                collapsed: editingTaskId ? tasks.find(t => t.id === editingTaskId).collapsed : false
            };

            if (editingTaskId) {
                const idx = tasks.findIndex(t => t.id === editingTaskId);
                tasks[idx] = data;
            } else {
                // Positional Insertion
                let insIdx = tasks.length;
                if (parentId) {
                    const pIdx = tasks.findIndex(t => t.id == parentId);
                    if (pIdx >= 0) {
                        let lastC = pIdx;
                        for(let i=pIdx+1; i<tasks.length; i++) {
                            if (tasks[i].parentId == parentId) lastC = i;
                            else if (!tasks[i].parentId) break;
                        }
                        insIdx = lastC + 1;
                    }
                }
                tasks.splice(insIdx, 0, data);
            }
            closeModal(); applyFilters();
        }

        function deleteTask(id) {
            if (confirm('Delete?')) {
                tasks = tasks.filter(t => t.id !== id && t.parentId != id);
                tasks.forEach(t => { if(t.dependencies) t.dependencies = t.dependencies.filter(d => d !== id); });
                applyFilters();
            }
        }

        function closeModal() { document.getElementById('taskModal').classList.remove('active'); }
        function showHelp() { document.getElementById('helpModal').classList.add('active'); }
        function closeHelp() { document.getElementById('helpModal').classList.remove('active'); }
        function setDeadline() { const d = prompt('Deadline (YYYY-MM-DD):', deadline || ''); if (d !== null) { deadline = d || null; render(); } }

        function saveProject() {
            const blob = new Blob([JSON.stringify({ startDate: startDate.toISOString().split('T')[0], numWeeks, tasks, deadline, assigneeList }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gantt.json'; a.click();
        }

        function loadProject() { document.getElementById('fileInput').click(); }

        document.getElementById('fileInput').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => {
                const p = JSON.parse(ev.target.result);
                startDate = new Date(p.startDate); numWeeks = p.numWeeks; tasks = p.tasks || []; deadline = p.deadline; assigneeList = p.assigneeList || [];
                document.getElementById('startDate').value = p.startDate; document.getElementById('numWeeks').value = p.numWeeks;
                applyFilters();
            };
            r.readAsText(e.target.files[0]);
        };

        function exportToPNG() {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = () => {
                html2canvas(document.querySelector('.container'), { scale: 2 }).then(canvas => {
                    const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = 'gantt.png'; a.click();
                });
            };
            document.head.appendChild(script);
        }

        function formatDate(d) { return `${d.getDate()}/${d.getMonth() + 1}`; }

        initializeDate();
        updateTimeline();
    </script>
</body>
</html>
